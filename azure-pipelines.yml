trigger:
- wps-cmake

variables:
  WRF_REPO: WRF-CMake/WRF
  WRF_COMMIT: letmaik/azure-pipelines
  WATS_REPO: WRF-CMake/wats
  WATS_BRANCH: master
  WATS_MODE: wps

jobs:
- job: windows_cmake_serial
  pool:
    vmImage: vs2017-win2016
  variables:
    OS_NAME: windows
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    MODE: serial
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/windows.yml

- job: windows_cmake_dmpar
  pool:
    vmImage: vs2017-win2016
  variables:
    OS_NAME: windows
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    MODE: dmpar
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/windows.yml

# TODO CC/FC are not used for Make builds

- job: ubuntu_make_serial
  pool:
    vmImage: ubuntu-16.04
  variables:
    OS_NAME: linux
    BUILD_SYSTEM: make
    BUILD_TYPE: Debug
    CC: gcc
    FC: gfortran
    MODE: serial
  steps:
  - template: .ci/azure/unix.yml

- job: ubuntu_make_dmpar
  pool:
    vmImage: ubuntu-16.04
  variables:
    OS_NAME: linux
    BUILD_SYSTEM: make
    BUILD_TYPE: Debug
    CC: gcc
    FC: gfortran
    MODE: dmpar
  steps:
  - template: .ci/azure/unix.yml

- job: ubuntu_cmake_serial
  pool:
    vmImage: ubuntu-16.04
  variables:
    OS_NAME: linux
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    CC: gcc
    FC: gfortran
    MODE: serial
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/unix.yml

- job: ubuntu_cmake_dmpar
  pool:
    vmImage: ubuntu-16.04
  variables:
    OS_NAME: linux
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    CC: gcc
    FC: gfortran
    MODE: dmpar
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/unix.yml

- job: macos_make_serial
  pool:
    vmImage: macos-10.13
  variables:
    OS_NAME: osx
    BUILD_SYSTEM: make
    BUILD_TYPE: Debug
    CC: gcc-8
    FC: gfortran-8
    MODE: serial
  steps:
  - template: .ci/azure/unix.yml

- job: macos_make_dmpar
  pool:
    vmImage: macos-10.13
  variables:
    OS_NAME: osx
    BUILD_SYSTEM: make
    BUILD_TYPE: Debug
    CC: gcc-8
    FC: gfortran-8
    MODE: dmpar
  steps:
  - template: .ci/azure/unix.yml

- job: macos_cmake_serial
  pool:
    vmImage: macos-10.13
  variables:
    OS_NAME: osx
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    CC: gcc-8
    FC: gfortran-8
    MODE: serial
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/unix.yml

- job: macos_cmake_dmpar
  pool:
    vmImage: macos-10.13
  variables:
    OS_NAME: osx
    BUILD_SYSTEM: cmake
    BUILD_TYPE: Debug
    CC: gcc-8
    FC: gfortran-8
    MODE: dmpar
    GRIB1: 0
    GRIB2: 1
    NESTING: basic
  steps:
  - template: .ci/azure/unix.yml

- job: wats_diff
  pool:
    vmImage: ubuntu-16.04
  dependsOn:
  #- windows_cmake_serial
  #- windows_cmake_dmpar # failing currently
  - ubuntu_make_serial
  #- ubuntu_make_dmpar
  - ubuntu_cmake_serial
  #- ubuntu_cmake_dmpar
  #- macos_make_serial
  #- macos_make_dmpar
  #- macos_cmake_serial
  #- macos_cmake_dmpar
  steps:
  - checkout: none
  
  #- task: DownloadPipelineArtifact@1
  #  displayName: Retrieve WATS outputs
  #  inputs:
  #    downloadPath: wats_outputs

  - task: DownloadBuildArtifacts@0
    displayName: Retrieve WATS outputs
    inputs:
      downloadPath: wats_outputs
      downloadType: specific
  
  - script: |
      cd wats_outputs
      find . -type f
    displayName: List WATS output files
  
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
  
  - script: |
      git clone --depth=1 --branch=$WATS_BRANCH https://github.com/$WATS_REPO.git wats
      pip install -r wats/requirements.txt
    displayName: Install WATS
  
  - script: |
      set -ex
      O=wats_outputs
      W="python wats/wats/main.py diff --mode $WATS_MODE"
      $W $O/ubuntu_make_serial $O/ubuntu_cmake_serial
      #$W $O/ubuntu_make_dmpar $O/ubuntu_cmake_dmpar
      #$W $O/macos_make_serial $O/macos_cmake_serial
      #$W $O/macos_make_dmpar $O/macos_cmake_dmpar
      #$W $O/ubuntu_make_serial $O/windows_cmake_serial
      # $W $O/ubuntu_make_dmpar $O/windows_cmake_dmpar # failing currently
    displayName: Run WATS diff
      